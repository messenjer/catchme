define(["require","zepto","underscore","backbone","./anim","./header","./footer"],function(e){function u(){this._stack=[],this.manualLayout=!0,this.stackSize=function(){return this._stack.length},this.clearStack=function(){var e=this._stack;while(e.length)e[e.length-1].close()}}var t=e("zepto"),n=e("underscore"),r=e("backbone"),i=e("./anim"),s=e("./header"),o=e("./footer"),a=r.View.extend({initialize:function(){this.initView()},initView:function(){var e=t(this.el);this._stack=[],this.manualLayout=e.data("layout")=="manual",this.anim=e.data("animation");var n=e.parent().get(0);n.view||n.proxyView?this.parent=n.view||n.proxyView:n.view=this.parent=new u,this.initMarkup()},initMarkup:function(){var e=t(this.el);e.children("header").length&&(this.header=new s(this),e.children("header").remove()),e.children("footer").length&&(this.footer=new o(this),e.children("footer").remove());var n=Array.prototype.slice.call(e[0].childNodes),r=t(n);this.manualLayout?(r.length?r.wrapAll('<div class="_contents"></div>'):e.append('<div class="_contents"></div>'),e.children("._contents").get(0).proxyView=this):(r.length?(r.wrapAll('<div class="contents"></div>'),e.children(".contents").wrap('<div class="_contents"></div>')):e.append('<div class="_contents"><div class="contents"></div></div>'),e.children("._contents").children(".contents").get(0).proxyView=this),this.header&&e.prepend(this.header.el),this.footer&&e.append(this.footer.el),this.onResize()},onResize:function(){var e=t(this.el),n=e.children("header").height()+e.children("footer").height();e.children("._contents").css({height:e.height()-n}),this.header&&this.header.setTitle(this.header.getTitle())},stackSize:function(){return this._stack.length},clearStack:function(){var e=this._stack;while(e.length)e[e.length-1].close()},setTitle:function(){if(!this.header)return;var e=this.options.titleField||"title",t=this.model,n;this.getTitle?n=this.getTitle(t):t&&t.get(e)?n=t.get(e):n=this.header.getTitle(),this.header.setTitle(n)},open:function(e,t){t=t||this.anim||"slideLeft",this.lastAnimation=t;var r=this.parent._stack;if(r.indexOf(this.el)!==-1)return;if(i[t]){var s=r.length,o=null;s&&(o=r[s-1]),i[t](o,this.el)}else console.log("WARNING: invalid animation: "+t);r.length&&this.header?this.header.addBack(this):this.header&&this.header.removeBack(),r.push(this.el),this.model=e,this.setTitle(),this.model&&this.model.on("change",n.bind(this.render,this)),this.render(),this.onOpen&&this.onOpen(this)},openAlone:function(e,t){t=t||"instant",i[t]?i[t](null,this.el):console.log("WARNING: invalid animation: "+t),this.header&&this.header.removeBack(),this.model=e,this.setTitle(),this.render(),this.onOpen&&this.onOpen(this)},close:function(e){if(!e)switch(this.lastAnimation){case"slideLeft":e="slideRightOut";break;case"slideRight":e="slideLeftOut";break;case"slideUp":e="slideDownOut";break;case"slideDown":e="slideUpOut";break;default:e="slideRightOut"}var t=this.parent._stack,n=t.length;n>1&&(t[n-1]==this.el&&t.pop(),i[e](t[n-2],this.el),this.model=null)},render:function(){var e=this.model;this.options.render&&this.options.render.call(this.el,e)}});return a})